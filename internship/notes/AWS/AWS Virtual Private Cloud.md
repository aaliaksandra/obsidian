
### **CIDR, Private IP vs. Public IP 

**CIDR (Classless Inter-Domain Routing)**

- Метод **бесклассовой междоменной маршрутизации**. Это способ более эффективного выделения IP-адресов и маршрутизации пакетов.
    
- **Использование:** Широко используется в правилах **Security Groups** в AWS, а также в целом в сетевых настройках AWS и Интернета.
    
- **Формат:** IP-адрес/длина префикса (например, `192.168.0.0/24`).

**CIDR и Диапазоны IP-адресов:**

- CIDR-нотация помогает определить **диапазон IP-адресов** и количество адресов в нем. `/длина_префикса` (или "маска подсети" в более старой терминологии) указывает, сколько бит в IP-адресе используются для идентификации сети.
    
    - `WWW.XX.YY.ZZ/32`: Означает **один конкретный IP-адрес**. Все 32 бита фиксированы.
        
    - `0.0.0.0/0`: Означает **все возможные IP-адреса**. Это "любой IP-адрес" или "Интернет".
        
    - `192.168.0.0/26`: Определяет диапазон из **64 IP-адресов**.
        
        - Маска подсети `/26` означает, что первые 26 бит IP-адреса являются сетевой частью, а оставшиеся `32 - 26 = 6` бит используются для адресов хостов.
            
        - `2^6 = 64` возможных адреса (включая сетевой адрес и широковещательный адрес).
            
        - Диапазон: `192.168.0.0` - `192.168.0.63`.
            

**Маска подсети (Subnet Mask):**

- Это концепция, тесно связанная с CIDR. В традиционной нотации маска подсети (например, `255.255.255.0`) явно указывает, какие биты IP-адреса относятся к сетевой части, а какие — к хостовой.
    
- В CIDR, `/длина_префикса` (например, `/24`) эквивалентна маске подсети (`255.255.255.0`). Оба способа определяют размер сети (подсети).
    

**4. Публичные vs. Приватные IP-адреса (IPv4):**

- **Управление:** Internet Assigned Numbers Authority (IANA) зарезервировала определенные блоки IP-адресов IPv4 для использования в качестве приватных (для локальных сетей - LAN) и публичных (для Интернета) адресов.
    
- **Приватные IP-адреса (Private IP):**
    
    - Могут использоваться только **внутри локальных (частных) сетей** и не маршрутизируются в публичном Интернете.
        
    - **Диапазоны, зарезервированные IANA:**
        
        - `10.0.0.0 – 10.255.255.255` (`10.0.0.0/8`): Используется в очень больших сетях.
            
        - `172.16.0.0 – 172.31.255.255` (`172.16.0.0/12`): **Диапазон по умолчанию для AWS VPC**.
            
        - `192.168.0.0 – 192.168.255.255` (`192.168.0.0/16`): Часто используется в домашних сетях.
        
    - Это позволяет многим сетям использовать одни и те же приватные IP-адреса, не конфликтуя друг с другом в Интернете.
        
- **Публичные IP-адреса (Public IP):**
    
    - **Все остальные IP-адреса** в Интернете, которые не входят в зарезервированные приватные диапазоны, являются публичными.
        
    - Они **глобально уникальны** и маршрутизируются в публичном Интернете.


### **Default VPC**

- Каждая новая учетная запись AWS **автоматически имеет Default VPC** в каждом регионе.

**Основные характеристики Default VPC:**

- **Подключение к Интернету (Internet connectivity):** Default VPC изначально настроен так, чтобы инстансы внутри него имели доступ к Интернету.
- **Публичные IPv4-адреса:** Все инстансы EC2, запущенные в подсетях Default VPC, по умолчанию получают публичные IPv4-адреса.
- **DNS-имена:** Инстансы также получают публичные и приватные IPv4 DNS-имена.

**Важные компоненты Default VPC для связи с Интернетом:**

Чтобы инстансы в Default VPC могли взаимодействовать с Интернетом, необходимы два ключевых сетевых компонента: **Internet Gateway** и **Route Table**.

- **Internet Gateway (IGW) - Интернет-шлюз:**
    
    - **Что это:** Это **логически избыточный (redundant)** и **высокодоступный компонент VPC**, который позволяет обеспечить связь между инстансами в вашей VPC и Интернетом.
        
    - **Функция:** IGW выполняет трансляцию сетевых адресов (NAT) для инстансов с публичными IP-адресами и служит целевым объектом для маршрутов в таблицы маршрутизации, направляющих трафик в Интернет.
    
- **Route Table (Таблица Маршрутизации):**
    
    - **Что это:** Набор правил, которые **определяют, куда направлять сетевой трафик** из подсетей. Каждая подсеть в VPC должна быть связана с таблицей маршрутизации.
        
    - **Содержимое:** В этой таблице маршрутизации есть записи, которые указывают:
        
        - **Локальные маршруты:** Маршрут для трафика внутри самой VPC (например, `172.31.0.0/16` -> `local`).
            
        - **Маршрут по умолчанию в Интернет:** Маршрут для всего трафика, предназначенного для Интернета (обычно `0.0.0.0/0` - "все IP-адреса") направляется на присоединенный **Internet Gateway**. Именно эта запись позволяет инстансам с публичными IP-адресами "видеть" Интернет.

**Связь между компонентами в Default VPC:**

Поток трафика для инстанса с публичным IP в Default VPC, взаимодействующего с Интернетом:

1. Инстанс отправляет трафик, предназначенный для Интернета.
    
2. Трафик поступает в подсеть.
    
3. Таблица маршрутизации, связанная с подсетью, проверяет, куда отправить трафик.
    
4. Находит маршрут `0.0.0.0/0` (или более специфичный публичный диапазон), который указывает на **Internet Gateway**.
    
5. Internet Gateway обеспечивает трансляцию адресов и перенаправляет трафик в публичный Интернет.
    
6. Для входящего трафика из Интернета процесс идет в обратном порядке: трафик приходит на публичный IP-адрес инстанса через IGW, который затем направляет его в VPC и подсеть.

### **VPC Overview**

- **VPC = Virtual Private Cloud (Виртуальное Приватное Облако):** Это изолированный, логически отдельный раздел облака AWS, в котором вы можете развертывать свои ресурсы AWS (такие как EC2-инстансы, базы данных, Lambda-функции и т.д.) в виртуальной сети, которую вы полностью контролируете.

**Ключевые характеристики VPC:**

- **Множество VPC:** Вы можете иметь несколько VPC в одном регионе AWS.
    
    - **Лимит:** По умолчанию, максимально 5 VPC на регион (это **"мягкий" лимит**, который можно запросить увеличить через поддержку AWS).
    
- **Диапазон CIDR для VPC:** Каждая VPC должна быть определена с одним или несколькими CIDR-блоками.
    
    - **Максимальное количество CIDR-блоков на VPC:** 5 (это также "мягкий" лимит).
        
    - **Минимальный размер CIDR-блока:** `/28` (что дает 16 IP-адресов).
        
    - **Максимальный размер CIDR-блока:** `/16` (что дает 65536 IP-адресов).
        
- **Использование только Приватных IP-адресов:**
    
    - Поскольку VPC является **приватным** (изолированным) облаком, для определения ее CIDR-блоков допускаются только **зарезервированные диапазоны приватных IPv4-адресов**, установленные IANA:
        
        - `10.0.0.0 – 10.255.255.255` (`10.0.0.0/8`)
            
        - `172.16.0.0 – 172.31.255.255` (`172.16.0.0/12`)
            
        - `192.168.0.0 – 192.168.255.255` (`192.168.0.0/16`)
           
- **Отсутствие пересечений CIDR:**
    
    - **Крайне важно, чтобы CIDR-диапазон вашей VPC НЕ пересекался (should NOT overlap)** с CIDR-диапазонами других ваших сетей, таких как ваша корпоративная сеть (on-premises), если вы планируете устанавливать с ней сетевое соединение (например, через VPN или AWS Direct Connect). Пересечения могут привести к проблемам с маршрутизацией и недоступности ресурсов.


### **Subnet overview**

- VPC может быть разделена на одну или несколько подсетей. Каждая подсеть располагается в одной Зоне Доступности (Availability Zone) и является диапазоном IP-адресов из CIDR-блока вашей VPC.

- AWS **резервирует 5 IP-адресов** в каждой подсети.
    
- Эти адреса **недоступны для использования** вами и **не могут быть назначены EC2-инстансам** или другим ресурсам.
    
- **Пример (для CIDR блока 10.0.0.0/24):**
    
    - `10.0.0.0`: **Network Address (Сетевой адрес)** – используется для идентификации подсети.
        
    - `10.0.0.1`: **Зарезервирован AWS для маршрутизатора VPC** (VPC Router).
        
    - `10.0.0.2`: **Зарезервирован AWS для маппинга на DNS-сервер, предоставляемый Amazon**.
        
    - `10.0.0.3`: **Зарезервирован AWS для будущего использования**.
        
    - `10.0.0.255`: **Network Broadcast Address (Широковещательный адрес)** – AWS не поддерживает широковещание в VPC, поэтому этот адрес также зарезервирован.


### **Internet Gateway & Route Tables**

- Компонент VPC, который позволяет ресурсам (например, EC2-инстансам) в вашей VPC **подключаться к Интернету** и принимать соединения из Интернета.
    

**Ключевые характеристики:**

- **Масштабируемость и доступность:** Горизонтально масштабируется (scales horizontally) и является **высокодоступным и избыточным (highly available and redundant)**. AWS управляет его инфраструктурой, вам не нужно беспокоиться о его доступности.
    
- **Создание и прикрепление:**
    
    - Должен быть **создан отдельно от VPC**.
        
    - После создания **прикрепляется к VPC**.
        
    - **Соотношение:** Одна VPC может быть прикреплена только к одному IGW, и наоборот (один IGW может быть прикреплен только к одной VPC).

- **Internet Gateway сам по себе не предоставляет доступ в Интернет.**
    
- Для того чтобы трафик из VPC мог достичь Интернета (или из Интернета в VPC), **необходимо также отредактировать таблицы маршрутизации (Route Tables)**. Таблица маршрутизации должна содержать маршрут, указывающий на IGW для трафика, предназначенного для Интернета (обычно `0.0.0.0/0`).

![[Pasted image 20250722153425.png]]


### **Bastion Hosts**

![[Pasted image 20250722154122.png]]

- Бастионный хост – это специальный EC2-инстанс, который служит **защищенной точкой входа** для безопасного SSH-доступа к вашим **приватным EC2-инстансам**, расположенным в приватных подсетях VPC.
    
- **Причина использования:** Приватные инстансы не имеют прямого доступа из Интернета, что делает их более безопасными. Бастионный хост предоставляет контролируемый и мониторируемый путь доступа.
   
**Размещение и подключение:**

- Бастионный хост размещается в **публичной подсети (Public Subnet)** вашей VPC.
    
- Эта публичная подсеть должна быть настроена так, чтобы иметь маршрутизацию к другим **приватным подсетям**, где находятся ваши основные EC2-инстансы.

**Настройка Security Groups (Групп Безопасности):**

- **Security Group Бастионного Хоста (Bastion Host Security Group - BastionHost-SG):**
    
    - Должна **разрешать входящий трафик (inbound)** из Интернета на **порт 22 (для SSH)**.
        
    - **Важно:** Этот доступ должен быть ограничен только **разрешенным диапазоном IP-адресов** (например, публичный CIDR-диапазон вашей корпоративной сети), а не `0.0.0.0/0` (доступ со всего Интернета).
    
- **Security Group Приватных EC2-инстансов (LinuxInstance-SG):**
    
    - Должна **разрешать входящий трафик SSH (порт 22)**.
        
    - **Источник этого трафика должен быть:**
        
        - Либо **Security Group Бастионного Хоста (BastionHost-SG)**. Это предпочтительный способ, так как он автоматически адаптируется к изменениям IP-адреса бастиона.
            
        - Либо **приватный IP-адрес самого бастионного хоста**. Менее гибкий вариант.

**Процесс подключения:**
- **Users (Пользователи)** сначала устанавливают **SSH-соединение с Бастионным Хостом** в публичной подсети.
    
- Затем, с Бастионного Хоста, пользователи устанавливают **второе SSH-соединение с приватными EC2-инстансами** в приватных подсетях.


### **NAT Instance**

NAT Instance считается **устаревшим (outdated)** решением, и AWS рекомендует использовать **NAT Gateway**. 

- **NAT (Network Address Translation - Преобразование Сетевых Адресов):** Технология, позволяющая множеству устройств в приватной сети использовать один публичный IP-адрес для доступа к Интернету.
    
- **Назначение:** NAT Instance – это **специальный EC2-инстанс**, который запускается в публичной подсети и позволяет EC2-инстансам из **приватных подсетей** устанавливать исходящие соединения с Интернетом. Он не позволяет входящие соединения из Интернета к приватным инстансам.

- **Размещение:** Должен быть запущен в **публичной подсети (Public Subnet)** вашей VPC.
    
- **Elastic IP (EIP):** К NAT Instance **должен быть прикреплен Elastic IP-адрес**. Это публичный статический IP, через который NAT Instance будет общаться с Интернетом.
    
- **Отключение Source / Destination Check:** Для инстанса NAT **необходимо отключить параметр "Source / Destination Check"** в его сетевых настройках. Это позволяет NAT Instance пересылать трафик, источником или назначением которого не является он сам. Без этого параметра инстанс будет работать как обычный EC2 и отбрасывать чужой трафик.
    
- **Конфигурация Таблиц Маршрутизации (Route Tables):**
    
    - Таблицы маршрутизации **приватных подсетей** должны быть настроены так, чтобы весь исходящий трафик, предназначенный для Интернета (`0.0.0.0/0`), направлялся на **NAT Instance** (точнее, на его сетевой интерфейс - ENI).


### **NAT Gateway**

![[Pasted image 20250722160340.png]]

- Полностью **управляемый AWS сервис NAT** (Network Address Translation), который позволяет EC2-инстансам в **приватных подсетях** устанавливать исходящие соединения с Интернетом или другими сервисами за пределами VPC, при этом не позволяя входящие соединения из Интернета.
    
- **Преимущества перед NAT Instance:**
    
    - **Высокая пропускная способность (higher bandwidth):** Начинает с 5 Гбит/с и автоматически масштабируется до 100 Гбит/с.
    - **Высокая доступность (high availability):** В рамках одной Зоны Доступности.
    - **Нет администрирования (no administration):** AWS полностью управляет инфраструктурой NAT Gateway. Вам не нужно запускать EC2-инстансы, управлять ими, или настраивать группы автомасштабирования.

- **Размещение:** NAT Gateway **создается в конкретной Зоне Доступности (Availability Zone)**.
    
- **Elastic IP:** При создании NAT Gateway ему **назначается Elastic IP-адрес**. Именно через этот публичный IP-адрес NAT Gateway будет взаимодействовать с Интернетом.
    
- **Требуется Internet Gateway (IGW):** Для работы NAT Gateway **обязательно нужен Internet Gateway**, присоединенный к вашей VPC. Путь трафика для исходящего интернет-доступа: `Private Subnet => NAT Gateway => Internet Gateway`.
    
- **Ограничение использования:** NAT Gateway **не может использоваться EC2-инстансами, находящимися в той же подсети**, что и сам NAT Gateway. Он предназначен для маршрутизации трафика из _других_ подсетей.
    
- **Без Security Groups:** Для NAT Gateway **не нужно управлять Security Groups** (они не применяются к нему).

![[Pasted image 20250722160715.png]]

- **Устойчивость в пределах одной AZ:** `NAT Gateway is resilient within a single Availability Zone`. Это означает, что AWS обеспечивает его высокую доступность и отказоустойчивость _внутри той AZ, где он развернут_.
    
- **Требование для отказоустойчивости между AZ:**
    
    - Для обеспечения **отказоустойчивости на уровне нескольких Зон Доступности (fault-tolerance)**, вы **должны создать несколько NAT Gateway в нескольких AZ**.
        
    - Типичная архитектура:
        
        - Создать NAT Gateway в каждой публичной подсети в каждой AZ, где у вас есть приватные подсети, нуждающиеся в интернет-доступе.
            
        - Каждая приватная подсеть должна иметь маршрут в своей таблице маршрутизации, указывающий на NAT Gateway в _той же самой Зоне Доступности_.
            
- **Нет меж-AZ "failover" в традиционном смысле:** Если Зона Доступности (AZ) выходит из строя (`if an AZ goes down`), то инстансы в этой AZ будут недоступны, и им уже не потребуется NAT Gateway. Поэтому нет необходимости в кросс-AZ failover для самого NAT Gateway; вместо этого, вы просто используете NAT Gateway, специфичный для каждой AZ. Ваши приложения должны быть спроектированы для работы в нескольких AZ, и тогда каждый компонент (включая NAT Gateway) будет работать в своей AZ.


### **NACLs & Security Groups**

![[Pasted image 20250722161748.png]]

**Stateful** означает, что **ответ на соединение автоматически разрешён**, если был разрешён исходящий запрос.
**Stateless** означает, что **для каждого направления нужно явное разрешение**.

- **Назначение:** NACL – это дополнительный уровень безопасности, который действует как **межсетевой экран (firewall) для контроля трафика, входящего в подсети и выходящего из них**.
    
- Работает на уровне **подсети (subnet level)**.

- К каждой подсети может быть привязан **только один NACL**.
    
- Новые подсети автоматически привязываются к **Default NACL (NACL по умолчанию)**.

- **Правила NACL (NACL Rules):**
    
    - Вы определяете набор правил, которые контролируют трафик.
        
    - **Номер правила (Rule number):** Каждое правило имеет номер от 1 до 32766.
        
    - **Приоритет:** Правила обрабатываются **по возрастанию номера** (т.е., более низкий номер имеет более высокий приоритет).
        
    - **Первое совпадение:** Как только трафик соответствует какому-либо правилу, это правило **немедленно применяется**, и дальнейшая обработка правил прекращается.
        
    - **Последнее правило - "звездочка" (*):** Последнее неявное правило (которое вы не видите в консоли, но оно всегда присутствует) — это `* DENY`. Оно **запрещает любой запрос, который не совпал ни с одним из явных правил** выше.
        
    - **Рекомендация AWS:** AWS рекомендует нумеровать правила с шагом в 100 (например, 100, 200, 300...), чтобы оставлять место для вставки новых правил между существующими.
        
- **Состояние по умолчанию для новых NACL:**
    
    - **Вновь созданные NACL (non-default)** по умолчанию **запрещают весь трафик** (implicitly deny everything). Это означает, что после создания NACL, вам нужно явно разрешить только тот трафик, который должен проходить.
        
    - _Примечание:_ Default NACL, который создается с VPC, изначально разрешает весь входящий и исходящий трафик.
        
- **Тип правил (Stateless):** NACL являются **бесстатусными (stateless)**. Это означает, что для каждого соединения необходимо явно разрешать как входящий, так и исходящий трафик. Например, если вы разрешаете входящий трафик на порт 80, вам также нужно явно разрешить исходящий трафик на ephemeral-порты (динамические порты, которые используются для ответов).
    
- **Блокировка IP-адресов:** NACL — это отличный способ **блокировать конкретные IP-адреса** на уровне подсети, так как правила могут быть настроены на "DENY".

**Ephemeral Ports**

Для установления сетевого соединения между двумя конечными точками (например, клиентом и сервером) они должны использовать порты. Порты идентифицируют конкретное приложение или сервис на устройстве.

- Клиент всегда подключается к **определенному (defined/fixed) порту** на сервере (например, порт 80 для HTTP, порт 443 для HTTPS, порт 22 для SSH).
    
    - Для _исходящего_ соединения клиент использует свой **эфемерный порт (ephemeral port)**. Это временный порт, который операционная система клиента выбирает из определенного диапазона для отправки запроса.
    
- Сервер слушает на своем **фиксированном порту**.
    
	- Когда сервер отправляет ответ клиенту, он отправляет его на **эфемерный порт**, который клиент использовал для исходного запроса.

![[Pasted image 20250722181033.png]]

### **VPC Peering**

- Механизм AWS, позволяющий **приватно соединять две VPC** (Virtual Private Clouds) друг с другом, используя **сеть AWS**.
    
- Соединенные VPC ведут себя так, как будто они находятся **в одной сети**, позволяя ресурсам (например, EC2-инстансам) обмениваться трафиком между ними напрямую.
    

**Ключевые правила и особенности VPC Peering:**

- **Отсутствие пересекающихся CIDR**
    
- **Не транзитивный**
    
    - VPC Peering-соединение **не является транзитивным**. Это означает, что если VPC A соединена с VPC B, а VPC B соединена с VPC C, то VPC A **не может напрямую связаться с VPC C** через VPC B.
        
    - Для связи между VPC A и VPC C необходимо установить **отдельное VPC Peering-соединение** между ними (VPC A — VPC C). Каждое соединение должно быть установлено для каждой пары VPC, которые нуждаются в связи.
        
- **Обновление таблиц маршрутизации (Update route tables):**
    
    - После создания VPC Peering-соединения, **необходимо вручную обновить таблицы маршрутизации (route tables) в подсетях КАЖДОЙ VPC**, участвующей в пиринге.
        
    - Это делается для того, чтобы инстансы EC2 (или другие ресурсы) знали, куда направлять трафик, предназначенный для CIDR-блока пиринговой VPC. Целью маршрута в этом случае будет VPC Peering-соединение.
        

![[Pasted image 20250723102612.png]]

**Важные моменты, которые полезно знать (Good to know):**

- **Меж-аккаунтный и Межрегиональный пиринг:**
    
    - Вы можете создавать VPC Peering-соединения между VPC, которые находятся:
        
        - **В разных AWS-аккаунтах.**
            
        - **В разных AWS-регионах** (межрегиональный пиринг).
            
- **Ссылки на Security Groups в пиринговой VPC:**
    
    - Вы можете **ссылаться на Security Group** ресурса, находящегося в **пиринговой VPC**, при настройке правил в вашей Security Group.
        
    - **Важно:** Эта функциональность работает только для кросс-аккаунтного пиринга **в одном и том же регионе**. Для межрегионального пиринга ссылаться на Security Groups таким образом нельзя.


### **VPC Endpoints (PrivateLinks)**

- VPC Endpoints (основанные на технологии AWS PrivateLink) позволяют вам **подключаться к большинству сервисов AWS и услугам, размещенным другими клиентами AWS (частным образом), используя приватную сеть AWS**, вместо того чтобы проходить через публичный Интернет.
    
- **Проблема:** Каждый сервис AWS по умолчанию имеет публичный URL и доступен через Интернет. Для инстансов в приватных подсетях (без публичного IP) это означает необходимость использовать NAT Gateway или Internet Gateway.
    
- **Решение:** VPC Endpoints устраняют необходимость в Internet Gateway, NAT Gateway или VPN-соединениях для доступа к большинству сервисов AWS из вашей VPC, что повышает безопасность и упрощает сетевую архитектуру.
    
- **Надежность:** Они избыточны (redundant) и горизонтально масштабируются.

**Типы VPC Endpoints:**

**а) Interface Endpoints (на базе PrivateLink):**

- Создает **Elastic Network Interface (ENI)** с приватным IP-адресом в вашей подсети. Этот ENI служит точкой входа для доступа к сервису AWS.
    
- К ENI Endpoint Interface **должна быть прикреплена Security Group**, контролирующая трафик.
    
- Поддерживает **большинство сервисов AWS**, а также сервисы, предоставляемые другими клиентами AWS (через PrivateLink).
       
- **Платные**.

**б) Gateway Endpoints:**

- Провизирует **шлюз (gateway)**. Вместо ENI, трафик к сервису маршрутизируется через эту точку.
    
- Должен быть указан как **цель (target) в таблице маршрутизации** вашей VPC.
    
- **Не используют Security Groups** (контроль доступа осуществляется через политики Endpoint Policy).
    
- **Поддержка сервисов:** Поддерживает **только Amazon S3 и Amazon DynamoDB**.
    
- **Бесплатные**.

**Выбор между Gateway и Interface Endpoint для S3 (и DynamoDB):**

- **На экзамене (и обычно):** **Gateway Endpoint, скорее всего, будет предпочтительным выбором для S3 (и DynamoDB)** из-за его **бесплатности** и простоты настройки через таблицы маршрутизации.
    
- **Когда предпочтителен Interface Endpoint для S3:**
    
    - Если доступ к S3 требуется из **онпремисной среды (on-premises)** через Site-to-Site VPN или Direct Connect.
        
    - Если доступ требуется из **другой VPC** (например, через VPC Peering).
        
    - Если доступ требуется из **другого региона**.
        
    - В этих случаях Gateway Endpoint не может быть использован, так как он локален для VPC и региона, и требуется Interface Endpoint (через PrivateLink), чтобы маршрутизация шла через AWS PrivateLink, а не через Интернет.
        

![[Pasted image 20250723104315.png]]

- **DynamoDB:** Это **публичный сервис AWS**, который доступен из Интернета.
    
- **Lambda в VPC:** Если ваша Lambda-функция развернута _внутри VPC_ (что обычно делается для доступа к приватным ресурсам в этой VPC, например, базам данных или EC2-инстансам), то для доступа к публичным сервисам AWS (таким как DynamoDB), ей требуется определенная сетевая конфигурация.
    

**Варианты доступа Lambda к DynamoDB (из VPC):**

**Option 1: Доступ через публичный Интернет (Access from the public internet)**

- **Принцип:** Lambda-функция отправляет трафик к публичной конечной точке DynamoDB через Интернет.
    
- **Требования для Lambda в VPC:** Поскольку Lambda находится в приватной подсети VPC (или любой подсети без прямого выхода в Интернет), ей необходим механизм для исходящего доступа в Интернет.
    
    - **NAT Gateway:** Для этого требуется **NAT Gateway**, который должен быть развернут в публичной подсети VPC.
        
    - **Internet Gateway (IGW):** Публичная подсеть с NAT Gateway должна иметь маршрут через **Internet Gateway (IGW)** для связи с Интернетом.
        
- **Поток трафика:** `Lambda (Private Subnet) => NAT Gateway (Public Subnet) => Internet Gateway => Internet => DynamoDB`.
    
- **Недостатки:** Трафик выходит в Интернет, что может быть нежелательно с точки зрения безопасности, и влечет за собой оплату за обработанные данные через NAT Gateway.
    

**Option 2 (лучше и бесплатно): Доступ из приватной сети VPC (Access from the private VPC network)**

- **Принцип:** Lambda-функция получает доступ к DynamoDB полностью внутри приватной сети AWS, не выходя в публичный Интернет.
    
- **Требования:**
    
    - **Развернуть VPC Gateway Endpoint для DynamoDB:** Это специальный тип VPC Endpoint, который предоставляет приватный маршрут к DynamoDB.
        
    - **Изменить таблицы маршрутизации (Route Tables):** Таблица маршрутизации приватной подсети, где находится Lambda-функция, должна быть обновлена так, чтобы трафик, предназначенный для DynamoDB, направлялся на этот **VPC Gateway Endpoint**.
        
- **Поток трафика:** `Lambda (Private Subnet) => VPC Gateway Endpoint for DynamoDB => DynamoDB`.
    
- **Преимущества:**
    
    - **Безопасность:** Трафик остается полностью в приватной сети AWS, не проходя через Интернет.
        
    - **Стоимость:** VPC Gateway Endpoints для DynamoDB **бесплатны**.
        
    - **Производительность:** Улучшенная производительность за счет использования оптимизированной внутренней сети AWS.

![[Pasted image 20250723104822.png]]
### **VPC FlowLogs**

- Сервис, который **собирает информацию об IP-трафике**, проходящем через сетевые интерфейсы в вашей Amazon VPC.
    
- **Уровни сбора логов:** 
    
    - Для всей **VPC (VPC Flow Logs)**
        
    - Для отдельных **подсетей (Subnet Flow Logs)**
        
    - Для отдельных **эластичных сетевых интерфейсов (Elastic Network Interface - ENI Flow Logs)**
        
- Помогает **мониторить и устранять проблемы с подключением (troubleshoot connectivity issues)**, а также обеспечивает видимость сетевой активности для целей безопасности и соответствия.
    
- **Управляемые интерфейсы AWS:** Собирает сетевую информацию также от управляемых интерфейсов AWS-сервисов, таких как ELB (Elastic Load Balancing), RDS (Relational Database Service), ElastiCache, Redshift, WorkSpaces, NAT Gateway, Transit Gateway и т.д.


**Куда отправляются Flow Logs (Data Destinations):** Данные Flow Logs могут быть отправлены в следующие места для хранения и анализа:

- **Amazon S3 Bucket:** Для долгосрочного хранения и последующего анализа (например, с помощью Athena).
    
- **Amazon CloudWatch Logs:** Для мониторинга в реальном времени, создания метрик и алертов.
    
- **Amazon Kinesis Data Firehose:** Для потоковой передачи логов в другие аналитические или целевые системы.
    

**Синтаксис и Поля Flow Logs:** Каждая запись Flow Log содержит ряд полей, описывающих сетевой поток. Ключевые поля:

- `srcaddr` и `dstaddr`: IP-адреса источника и назначения – помогают идентифицировать проблемные IP.
    
- `srcport` и `dstport`: Порты источника и назначения – помогают идентифицировать проблемные порты.
    
- **`action` (Ключевое поле для устранения проблем):**
    
    - Указывает, было ли действие (трафик) **разрешено (`ACCEPT`)** или **отклонено (`REJECT`)** по правилам Security Group или Network ACL.
        
    - Это поле критически важно для анализа шаблонов использования, выявления вредоносного поведения и устранения сетевых проблем.
        
    - `log-status`: Указывает статус доставки лога (например, `OK` для успешной доставки).
        

**Архитектуры использования VPC Flow Logs:** VPC Flow Logs могут быть интегрированы с различными сервисами AWS для анализа и реагирования:

- **Мониторинг Топ-IP-адресов:**
    
    - `VPC Flow Logs` -> `CloudWatch Logs` -> `CloudWatch Contributor Insights` -> `Top-10 IP addresses`.
        
    - Contributor Insights анализирует данные логов для выявления основных "участников" трафика (например, наиболее активные IP-адреса).
        
- **Алерты о подозрительной активности (Troubleshooting / Security Alerts):**
    
    - `VPC Flow Logs` -> `CloudWatch Logs` (с `Metric Filter` для SSH/RDP и т.д.) -> `CloudWatch Alarm` -> `Amazon SNS`.
        
    - Это позволяет настроить уведомления (например, по электронной почте) при обнаружении подозрительной активности, такой как большое количество отклоненных попыток SSH/RDP.
        
- **Глубокий анализ и визуализация:**
    
    - `VPC Flow Logs` -> `S3 Bucket` -> `Amazon Athena` (для выполнения SQL-запросов к логам на S3) -> `Amazon QuickSight` (для визуализации данных).
        
    - Подходит для ретроспективного анализа, аудита и создания дашбордов.
        

**Устранение проблем с Security Groups (SG) и Network ACL (NACL) с помощью Flow Logs (Смотрите поле "ACTION"):**

- **Помните:**
    
    - **NACLs** являются **stateless** и применяются на уровне подсети.
        
    - **Security Groups** являются **stateful** и применяются на уровне инстанса (ENI).
        
- **Анализ поля `ACTION`:**
    
    - **`REJECT` (отклонено):**
        
        - **Входящий `REJECT`:** Трафик был отклонен либо NACL, либо Security Group.
            
        - **Исходящий `REJECT`:** Трафик был отклонен либо NACL, либо Security Group.
            
    - **`ACCEPT`, но затем `REJECT`:**
        
        - **`Inbound ACCEPT`, затем `Outbound REJECT`:** Входящий трафик был разрешен NACL, но исходящий ответ (например, от сервера к клиенту) был **отклонен исходящим правилом NACL**. (Это часто указывает на неправильно настроенный бесстатусный NACL, где забыли разрешить эфемерные порты для ответа).
            
        - **`Outbound ACCEPT`, затем `Inbound REJECT`:** Исходящий трафик был разрешен NACL, но входящий ответ (от удаленного сервера) был **отклонен входящим правилом NACL**. (Также указывает на проблему с бесстатусным NACL).

### **AWS Site-to-Site VPN**

- Позволяет установить **защищенное и зашифрованное сетевое соединение** между вашей локальной (on-premises) сетью (например, корпоративным дата-центром) и вашей Amazon VPC.
    
- Трафик проходит через **публичный Интернет**, но при этом **зашифрован** (обычно используется IPsec VPN).

**2. Основные компоненты Site-to-Site VPN:**

**а) Virtual Private Gateway (VGW) - Виртуальный Приватный Шлюз:**

- **Где находится:** Это **VPN-концентратор на стороне AWS** VPN-соединения.
    
- VGW создается и **прикрепляется к VPC**, из которой вы хотите установить VPN-соединение.
    
- **ASN (Autonomous System Number):** Возможность кастомизировать ASN, если вы используете протокол динамической маршрутизации BGP (Border Gateway Protocol).
    

**б) Customer Gateway (CGW) - Клиентский Шлюз:**

- **Где находится:** Это **программное приложение или физическое устройство** (VPN-устройство) на стороне **клиента (вашей локальной сети)** VPN-соединения.
    
- **Совместимость:** AWS предоставляет документацию с протестированными устройствами Customer Gateway.
    
- **IP-адрес для использования (для CGW, расположенного On-premises):**
    
    - Если ваше VPN-устройство имеет **публичный, маршрутизируемый в Интернет IP-адрес**, используйте его.
        
    - Если ваше VPN-устройство находится **за NAT-устройством**, которое поддерживает NAT-T (NAT traversal), используйте **публичный IP-адрес NAT-устройства**.
        

**3. Настройка Site-to-Site VPN Connections:**

- **Включение Route Propagation (Распространение Маршрутов):**
    
    - **Важный шаг:** Необходимо **включить Route Propagation** (распространение маршрутов) для **Virtual Private Gateway** в таблице маршрутизации (Route Table), которая связана с вашими подсетями в VPC.
        
    - **Что это делает:** Позволяет маршрутам из вашей локальной сети (полученным через VPN-соединение) автоматически появляться в таблицах маршрутизации вашей VPC. Без этого трафик не будет знать, как попасть обратно в вашу локальную сеть.
        
- **Настройка Security Groups (SG):**
    
    - Если вы хотите пинговать свои EC2-инстансы из локальной сети, убедитесь, что вы **добавили протокол ICMP** во входящие правила (inbound) ваших **Security Groups** на EC2-инстансах.
        

**4. AWS VPN CloudHub:**

- Предоставляет **безопасную связь между несколькими локальными площадками**, если у вас есть несколько VPN-соединений с AWS.
    
- Использует модель **"hub-and-spoke" (звезда)**: VGW в AWS выступает в роли центрального хаба, а ваши локальные сети (через CGW) — в роли "спиц".
    
- Низкозатратная модель для первичного или вторичного сетевого подключения между различными локациями (только VPN).
    
- **Настройка:**
    
    - Для настройки необходимо **подключить несколько VPN-соединений к одному и тому же VGW**.
        
    - Настроить **динамическую маршрутизацию** (BGP) между CGW и VGW.
        
    - Правильно **сконфигурировать таблицы маршрутизации** в VPC, чтобы трафик между локальными сетями мог проходить через VGW.

### **AWS Direct Connect**

- Сервис AWS, который предоставляет **выделенное, приватное сетевое соединение** между вашей локальной (on-premises) сетью (удаленной сетью) и вашей Amazon VPC (или другими сервисами AWS).
    
- В отличие от VPN, которое использует публичный Интернет, Direct Connect — это **физическое прямое соединение**, не проходящее через Интернет.

**Как работает Direct Connect:**

- **Выделенное соединение:** Требуется физическое выделенное сетевое соединение, устанавливаемое между вашим дата-центром (DC) и одной из **AWS Direct Connect Location** (специально оборудованные точки присутствия AWS).
    
- **Virtual Private Gateway (VGW):** Вам все еще нужно настроить **Virtual Private Gateway (VGW)** на вашей VPC, к которому будет подключаться Direct Connect. VGW служит конечной точкой для вашего DX-соединения в AWS.
    

**Преимущества и Варианты Использования (Use Cases):**

- **Повышенная пропускная способность (Increase bandwidth throughput):**
    
    - Позволяет работать с очень большими наборами данных (large data sets) с более высокой скоростью передачи данных.
        
    - Часто имеет более низкую стоимость в долгосрочной перспективе по сравнению с использованием Интернета для больших объемов трафика.
        
- **Более стабильное сетевое взаимодействие (More consistent network experience):**
    
    - Обеспечивает предсказуемую сетевую производительность и меньшую задержку (lower latency), что критически важно для приложений, использующих потоки данных в реальном времени.
        
- **Гибридные среды (Hybrid Environments):**
    
    - Идеально подходит для создания гибридных облачных архитектур, где часть инфраструктуры остается локально (on-premises), а часть размещается в AWS.
        
- **Доступ к ресурсам:**
    
    - Позволяет получать доступ как к **публичным ресурсам AWS** (например, S3), так и к **приватным ресурсам** (например, EC2-инстансам в вашей VPC) по одному и тому же Direct Connect-соединению.
        
- Поддерживает как **IPv4**, так и **IPv6**.

![[Pasted image 20250723180955.png]]

Direct Connect Gateway – это компонент AWS, который позволяет вам использовать **одно физическое соединение AWS Direct Connect** для подключения к **нескольким VPC, которые находятся в разных AWS-регионах** (в рамках одного AWS-аккаунта)

- Без Direct Connect Gateway, каждое DX-соединение (или Virtual Interface) обычно привязывается к одному Virtual Private Gateway (VGW) и, следовательно, к одной VPC в одном регионе.
    
- Если у вас есть несколько VPC в разных регионах, и всем им нужен доступ к вашей локальной сети через Direct Connect, вам пришлось бы устанавливать отдельное физическое DX-соединение в каждом регионе или использовать сложные обходные пути.

- **Централизованный хаб:** Direct Connect Gateway действует как **централизованный хаб (hub)** для всех ваших приватных виртуальных интерфейсов (Private Virtual Interfaces - Private VIFs).
    
- **Подключение:**
    
    - Ваше физическое **`AWS Direct Connect connection`** подключается к `Direct Connect Gateway`.
        
    - Затем `Direct Connect Gateway` подключается к **`Virtual Private Gateway (VGW)` каждой целевой VPC** в разных регионах (например, `us-east-1` и `us-west-1`) с помощью приватных виртуальных интерфейсов.
        
- **Маршрутизация:** Трафик из вашей `Customer network` направляется через одно DX-соединение к `Direct Connect Gateway`, а затем маршрутизируется в нужную VPC в соответствующем регионе.

![[Pasted image 20250723181324.png]]

**1. Выделенные Подключения (Dedicated Connections):**

- **Что это:** Это **физический Ethernet-порт**, выделенный **исключительно одному клиенту** в локации AWS Direct Connect.
    
- **Пропускная способность (Capacity):**
    
    - Доступны скорости: **1 Гбит/с, 10 Гбит/с и 100 Гбит/с**.
        
- **Процесс заказа:**
    
    - Запрос на подключение сначала отправляется **непосредственно в AWS**.
        
    - Затем процесс завершается **партнерами AWS Direct Connect** (например, colocation-провайдерами или провайдерами связи), которые фактически прокладывают физическое соединение.
        

**2. Размещенные Подключения (Hosted Connections):**

- **Что это:** Это подключение, которое предоставляется **через партнера AWS Direct Connect**. Партнер владеет физическим портом и делит его между несколькими клиентами.
    
- **Пропускная способность (Capacity):**
    
    - Доступны скорости: **50 Мбит/с, 500 Мбит/с и до 10 Гбит/с**.
        
    - Более конкретные скорости (1, 2, 5, 10 Гбит/с) доступны у некоторых избранных партнеров AWS Direct Connect.
        
- **Процесс заказа:**
    
    - Запросы на подключение отправляются **через партнеров AWS Direct Connect**.
        
- **Гибкость:** Пропускную способность можно **добавлять или удалять по требованию (on demand)**, что обеспечивает большую гибкость.


По умолчанию, данные, передаваемые по соединению Direct Connect, **не шифруются**.
Однако, соединение является **приватным**. Это означает, что трафик проходит по выделенной сетевой линии, а не по публичному Интернету, что обеспечивает физическую изоляцию и снижает риски перехвата по сравнению с передачей по Интернету.

Если вам требуется **шифрование трафика** поверх Direct Connect, вы можете комбинировать **AWS Direct Connect с VPN-соединением (IPsec VPN)**.
Особенно актуально для трафика, который по своей природе требует шифрования (например, для соблюдения нормативных требований или для очень чувствительных данных).

![[Pasted image 20250723182253.png]]

**1. Высокая Отказоустойчивость для Критических Рабочих Нагрузок (High Resiliency for Critical Workloads):**

- **Принцип:** `One connection at multiple locations` (Одно соединение в нескольких локациях).
    
- **Архитектура:**
    
    - У вас есть **один Virtual Private Gateway (VGW)** в вашей VPC (в одном AWS Region).
        
    - От вашей `Corporate data center` (корпоративного дата-центра) устанавливаются **два отдельных Direct Connect-соединения**.
        
    - Эти два соединения завершаются в **разных AWS Direct Connect Locations** (например, `AWS Direct Connect Location - 1` и `AWS Direct Connect Location - 2`).
        
    - Каждое из этих соединений затем подключается к вашему VGW в AWS.
        
- **Преимущество:** Обеспечивает избыточность на уровне физического соединения и точек присутствия Direct Connect. Если одна локация или одно физическое соединение выйдет из строя, другое продолжит работать.
    
- **Сценарий:** Подходит для большинства критически важных приложений, где требуется защита от сбоев физического соединения или одной локации DX.
    

**2. Максимальная Отказоустойчивость для Критических Рабочих Нагрузок (Maximum Resiliency for Critical Workloads):**

- **Принцип:** `Maximum resilience is achieved by separate connections terminating on separate devices in more than one location` (Максимальная отказоустойчивость достигается за счет отдельных соединений, завершающихся на отдельных устройствах в более чем одной локации).
    
- **Архитектура (более комплексная):**
    
    - У вас все еще есть **один Virtual Private Gateway (VGW)** в вашей VPC.
        
    - От вашего `Corporate data center` устанавливаются **четыре Direct Connect-соединения**, сгруппированные по парам.
        
    - **Две пары соединений** ведут к **двум разным AWS Direct Connect Locations** (`AWS Direct Connect Location - 1` и `AWS Direct Connect Location - 2`).
        
    - Внутри каждого `AWS Direct Connect Location`, соединения от `Corporate data center` завершаются на **разных клиентских маршрутизаторах/устройствах** (`Customer router/firewall`) и подключаются к **разным портам (endpoint)** AWS.
        
    - Все четыре соединения затем подключаются к вашему VGW в AWS.
        
- **Преимущество:** Это обеспечивает **избыточность на всех уровнях**:
    
    - Несколько физических соединений.
        
    - Несколько точек присутствия Direct Connect.
        
    - Несколько маршрутизаторов/устройств на стороне клиента.
        
    - Несколько портов на стороне AWS.
        
- **Сценарий:** Подходит для самых критически важных рабочих нагрузок, где любой простой в связи неприемлем, и требуется максимальная защита от самых разнообразных сценариев сбоев (например, от сбоя целого дата-центра или крупного сбоя в сети провайдера).


### **Transit Gateway**

- Transit Gateway – это сетевой хаб, который обеспечивает **транзитивный пиринг** (transitive peering) и **централизованную модель подключения типа "звезда" (hub-and-spoke)** для **тысяч VPC** и ваших **локальных сетей (on-premises)**.
    
- Устраняет сложность создания множества индивидуальных VPC Peering-соединений, когда у вас много VPC, которым нужен доступ друг к другу или к локальной сети (поскольку VPC Peering не транзитивен).
    

**Ключевые характеристики Transit Gateway:**

- **Региональный ресурс, но может работать кросс-регионально:** Transit Gateway создается в определенном регионе, но вы можете устанавливать пиринг между Transit Gateways в разных регионах для глобальной связности.
    
- **Кросс-аккаунтный шаринг (Share cross-account):** Вы можете делиться Transit Gateway между разными аккаунтами AWS, используя **Resource Access Manager (RAM)**, что упрощает управление сетевой связностью в AWS Organizations.
    
- **Таблицы маршрутизации (Route Tables):** Вы используете таблицы маршрутизации Transit Gateway, чтобы **ограничивать, какая VPC может связываться с другой VPC**, обеспечивая гранулярный контроль над сетевым трафиком.
    
- **Интеграция с другими сервисами:** Работает с **Direct Connect Gateway** (для подключения локальных сетей через выделенное соединение) и **VPN-соединениями** (для подключения локальных сетей через Интернет).
    
- **Поддержка IP Multicast:** Transit Gateway - **единственный сервис AWS**, который поддерживает **IP Multicast**. Это важно для приложений, которым требуется передача данных одному ко многим (например, для потокового видео, финансовых данных и т.д.).
    

**ECMP (Equal-Cost Multi-Path Routing) с Transit Gateway:**

- **Определение:** **ECMP = Equal-cost multi-path routing (Многопутевая маршрутизация по равной стоимости)**.
    
- **Стратегия:** Это стратегия маршрутизации, которая позволяет **пересылать пакет по нескольким "наилучшим" путям**, когда у вас есть несколько равноценных маршрутов к одной и той же цели.
    
- **Сценарий использования с Transit Gateway:**
    
    - Позволяет **создавать несколько Site-to-Site VPN-соединений** к AWS через Transit Gateway.
        
    - Это используется для **увеличения пропускной способности** вашего VPN-соединения с AWS, так как трафик может быть распределен между несколькими туннелями.
        
    - Также ECMP повышает отказоустойчивость, так как трафик может автоматически переключаться на доступные пути в случае сбоя одного из них.

### **VPC - Traffic Mirroring**

- Сервис AWS, который позволяет **захватывать (capture) и анализировать (inspect) сетевой трафик** из вашей VPC.
    
- Направляет копию этого трафика на устройства безопасности или мониторинга, которыми вы управляете.
    

**Как работает Traffic Mirroring:**

- **Источники (Sources):**
    
    - Трафик захватывается **от сетевых интерфейсов (ENIs)** ваших источников.
        
    - Может захватываться весь входящий (`Inbound traffic`) и исходящий (`Outbound traffic`) трафик.
        
- **Цели (Targets):**
    
    - Захваченный трафик направляется к **целевым устройствам (Traffic Mirroring Target)**.
        
    - Целью может быть:
        
        - Другой **ENI (Elastic Network Interface)**.
            
        - **Network Load Balancer (NLB)** (как показано на схеме), который затем распределяет трафик между группой инстансов.
            
- **Опциональная фильтрация:** Вы можете **отфильтровать трафик (filter traffic, optional)**, чтобы захватывать только интересующие вас пакеты.
    
- **Захват пакетов:** Можно захватывать **все пакеты** или только **пакеты, представляющие интерес** (с возможностью усечения пакетов - `truncate packets`, чтобы захватывать только заголовки).
    
- **Размещение Источника и Цели:**
    
    - Источник и Цель могут находиться **в одной и той же VPC**.
        
    - Источник и Цель могут находиться в **разных VPC**, если они соединены через **VPC Peering**.

![[Pasted image 20250724105813.png]]


### **IPv6 in VPC**

**Основы IPv6 в VPC:**

- **IPv4 является обязательным:** Вы **не можете отключить IPv4** для вашей VPC и подсетей. VPC всегда будет иметь IPv4-адресацию.
    
- **Включение IPv6:** Вы можете **включить IPv6** для своей VPC и ее подсетей, чтобы они работали в **режиме двойного стека (dual-stack mode)**. Это означает, что ресурсы будут иметь как IPv4, так и IPv6 адреса.
    
- **Публичность IPv6-адресов:** IPv6-адреса, назначаемые в AWS VPC, по своей природе являются **публичными IP-адресами**. Это отличается от IPv4, где есть явное разделение на публичные и приватные диапазоны.

При включении IPv6 и назначении ему подсети, ваши инстансы EC2 будут получать **как минимум:**

- **Приватный внутренний IPv4-адрес.**
    
- **Публичный IPv6-адрес.**


- Инстансы EC2, имеющие как IPv4, так и IPv6 адреса, могут обмениваться данными с Интернетом, используя **либо IPv4, либо IPv6**.
    
- Это соединение с Интернетом (для обоих протоколов) осуществляется через **Internet Gateway (IGW)**, который в режиме двойного стека обрабатывает как IPv4, так и IPv6 трафик.

### **Egress Only Internet Gateway**

- Это специальный тип шлюза, который используется **ТОЛЬКО для IPv6-трафика**.
    
- Его функциональность **похожа на NAT Gateway, но для IPv6**. Он позволяет исходящие соединения, но блокирует входящие соединения, инициированные из Интернета.
    

**Ключевые функции:**

- **Исходящие соединения по IPv6:** Позволяет инстансам в вашей VPC устанавливать **исходящие соединения** с Интернетом через IPv6.
    
- **Блокировка входящих инициируемых соединений:** **Предотвращает** возможность для публичного Интернета инициировать IPv6-соединения к вашим инстансам.
    
- **Почему это нужно для IPv6:**
    
    - В отличие от IPv4, где приватные IP-адреса не маршрутизируются в Интернете, все IPv6-адреса в AWS VPC по умолчанию являются публично маршрутизируемыми.
        
    - Если вы хотите дать своим инстансам в приватной подсети доступ к IPv6-интернету, но при этом защитить их от нежелательных входящих соединений из Интернета (аналогично тому, как NAT Gateway делает это для IPv4), вам нужен Egress-only Internet Gateway.
        
- **Требуется обновление таблиц маршрутизации:** Как и для других типов шлюзов, вы **должны обновить таблицы маршрутизации** подсетей, чтобы направлять IPv6-трафик через Egress-only Internet Gateway.

![[Pasted image 20250724112137.png]]


### **VPC - Network Firewall**

- Полностью управляемый сервис межсетевого экрана, который обеспечивает **защиту всей вашей Amazon VPC** на всех уровнях.
    
- Размещается на границе VPC, что позволяет ему инспектировать трафик, входящий и выходящий из вашей VPC.
    

**Уровни и Направления Защиты:**

- **Комплексная защита:** Предоставляет защиту от **Layer 3 (сетевой уровень)** до **Layer 7 (уровень приложения)**.
    
- **Любое направление трафика (Any direction):** Вы можете инспектировать и фильтровать трафик в любом направлении:
    
    - `VPC to VPC traffic` (трафик между VPC, если маршрутизируется через Firewall).
        
    - `Outbound to internet` (исходящий в Интернет).
        
    - `Inbound from internet` (входящий из Интернета).
        
    - `To / from Direct Connect & Site-to-Site VPN` (трафик, идущий через Direct Connect и Site-to-Site VPN-соединения).
        

**Возможности Правил (Rules):**

- **Поддержка тысяч правил:** Способен обрабатывать тысячи правил.
    
- **Типы правил:**
    
    - **IP & Port:** Фильтрация по IP-адресам и портам (например, 10 000 IP-адресов).
        
    - **Protocol:** Блокировка определенных протоколов (например, блокировка протокола SMB для исходящих коммуникаций).
        
    - **Stateful domain list rule groups:** Сохраняющие состояние группы правил на основе доменных имен. Позволяют разрешать исходящий трафик только к определенным доменам (например, `*.mycorp.com` или репозиториям стороннего ПО).
        
    - **General pattern matching using regex:** Общее сопоставление паттернов с использованием регулярных выражений для более сложной фильтрации содержимого.
        
- **Действия с трафиком (Traffic filtering):** Для трафика, который соответствует правилам, можно задать следующие действия:
    
    - `Allow` (разрешить).
        
    - `Drop` (отклонить/заблокировать).
        
    - `Alert` (отправить уведомление).
        

**Расширенные возможности безопасности:**

- **Active flow inspection (Активная инспекция потоков):**
    
    - Защищает от сетевых угроз с помощью **возможностей предотвращения вторжений (intrusion-prevention capabilities)**.
        
    - Внутренне AWS Network Firewall использует **AWS Gateway Load Balancer** для обеспечения высокой доступности и масштабируемости своей инспекционной функциональности.
        

**Логирование и Управление:**

- **Отправка логов:** Логи о срабатывании правил (rule matches) могут быть отправлены в:
    
    - `Amazon S3`.
        
    - `CloudWatch Logs`.
        
    - `Kinesis Data Firehose`.
        
- **Централизованное управление:** Правила могут централизованно управляться **кросс-аккаунтно (cross-account)** с помощью **AWS Firewall Manager** для применения к множеству VPC в AWS Organization.